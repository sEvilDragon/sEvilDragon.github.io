<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="首先，我是新手！ 首先，我是新手！！ 首先，我是新手！！！ （重要的事情说三遍！） 作为嵌入式新手，我的代码一定存在缺陷和不完美，实现的功能也十分基础，所以别让新人太难办呜呜呜~\n">
<title>~科中考核电子琴酱拯救计划~</title>

<link rel='canonical' href='https://sEvilDragon.github.io/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="~科中考核电子琴酱拯救计划~">
<meta property='og:description' content="首先，我是新手！ 首先，我是新手！！ 首先，我是新手！！！ （重要的事情说三遍！） 作为嵌入式新手，我的代码一定存在缺陷和不完美，实现的功能也十分基础，所以别让新人太难办呜呜呜~\n">
<meta property='og:url' content='https://sEvilDragon.github.io/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/'>
<meta property='og:site_name' content='小恐龙大魔王！—sEvil_Dragon'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='ELAB' /><meta property='article:published_time' content='2025-10-31T22:23:01&#43;08:00'/><meta property='article:modified_time' content='2025-10-31T22:23:01&#43;08:00'/><meta property='og:image' content='https://sEvilDragon.github.io/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/cover.jpg' />
<meta name="twitter:title" content="~科中考核电子琴酱拯救计划~">
<meta name="twitter:description" content="首先，我是新手！ 首先，我是新手！！ 首先，我是新手！！！ （重要的事情说三遍！） 作为嵌入式新手，我的代码一定存在缺陷和不完美，实现的功能也十分基础，所以别让新人太难办呜呜呜~\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://sEvilDragon.github.io/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/cover.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_78105d704d9c0801.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">💻</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">小恐龙大魔王！—sEvil_Dragon</a></h1>
            <h2 class="site-description">欢迎访问，这里是@小恐龙大魔王（sEvil_Dragon）的个人博客，由hugo(stack)与github搭建，用于个人分享与记录~</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/503735559?spm_id_from=333.1007.0.0'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.0.0-beta2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M488.6 104.1C505.3 122.2 513 143.8 511.9 169.8V372.2C511.5 398.6 502.7 420.3 485.4 437.3C468.2 454.3 446.3 463.2 419.9 464H92.02C65.57 463.2 43.81 454.2 26.74 436.8C9.682 419.4 .7667 396.5 0 368.2V169.8C.7667 143.8 9.682 122.2 26.74 104.1C43.81 87.75 65.57 78.77 92.02 78H121.4L96.05 52.19C90.3 46.46 87.42 39.19 87.42 30.4C87.42 21.6 90.3 14.34 96.05 8.603C101.8 2.868 109.1 0 117.9 0C126.7 0 134 2.868 139.8 8.603L213.1 78H301.1L375.6 8.603C381.7 2.868 389.2 0 398 0C406.8 0 414.1 2.868 419.9 8.603C425.6 14.34 428.5 21.6 428.5 30.4C428.5 39.19 425.6 46.46 419.9 52.19L394.6 78L423.9 78C450.3 78.77 471.9 87.75 488.6 104.1H488.6zM449.8 173.8C449.4 164.2 446.1 156.4 439.1 150.3C433.9 144.2 425.1 140.9 416.4 140.5H96.05C86.46 140.9 78.6 144.2 72.47 150.3C66.33 156.4 63.07 164.2 62.69 173.8V368.2C62.69 377.4 65.95 385.2 72.47 391.7C78.99 398.2 86.85 401.5 96.05 401.5H416.4C425.6 401.5 433.4 398.2 439.7 391.7C446 385.2 449.4 377.4 449.8 368.2L449.8 173.8zM185.5 216.5C191.8 222.8 195.2 230.6 195.6 239.7V273C195.2 282.2 191.9 289.9 185.8 296.2C179.6 302.5 171.8 305.7 162.2 305.7C152.6 305.7 144.7 302.5 138.6 296.2C132.5 289.9 129.2 282.2 128.8 273V239.7C129.2 230.6 132.6 222.8 138.9 216.5C145.2 210.2 152.1 206.9 162.2 206.5C171.4 206.9 179.2 210.2 185.5 216.5H185.5zM377 216.5C383.3 222.8 386.7 230.6 387.1 239.7V273C386.7 282.2 383.4 289.9 377.3 296.2C371.2 302.5 363.3 305.7 353.7 305.7C344.1 305.7 336.3 302.5 330.1 296.2C323.1 289.9 320.7 282.2 320.4 273V239.7C320.7 230.6 324.1 222.8 330.4 216.5C336.7 210.2 344.5 206.9 353.7 206.5C362.9 206.9 370.7 210.2 377 216.5H377z"/></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/sEvilDragon'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.549px" height="438.549px" viewBox="0 0 438.549 438.549" style="enable-background:new 0 0 438.549 438.549;"
	 xml:space="preserve">
<g>
	<path d="M409.132,114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736,15.166,259.057,5.365,219.271,5.365
		c-39.781,0-76.472,9.804-110.063,29.408c-33.596,19.605-60.192,46.204-79.8,79.8C9.803,148.168,0,184.854,0,224.63
		c0,47.78,13.94,90.745,41.827,128.906c27.884,38.164,63.906,64.572,108.063,79.227c5.14,0.954,8.945,0.283,11.419-1.996
		c2.475-2.282,3.711-5.14,3.711-8.562c0-0.571-0.049-5.708-0.144-15.417c-0.098-9.709-0.144-18.179-0.144-25.406l-6.567,1.136
		c-4.187,0.767-9.469,1.092-15.846,1c-6.374-0.089-12.991-0.757-19.842-1.999c-6.854-1.231-13.229-4.086-19.13-8.559
		c-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559
		c-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-0.951-2.568-2.098-3.711-3.429c-1.142-1.331-1.997-2.663-2.568-3.997
		c-0.572-1.335-0.098-2.43,1.427-3.289c1.525-0.859,4.281-1.276,8.28-1.276l5.708,0.853c3.807,0.763,8.516,3.042,14.133,6.851
		c5.614,3.806,10.229,8.754,13.846,14.842c4.38,7.806,9.657,13.754,15.846,17.847c6.184,4.093,12.419,6.136,18.699,6.136
		c6.28,0,11.704-0.476,16.274-1.423c4.565-0.952,8.848-2.383,12.847-4.285c1.713-12.758,6.377-22.559,13.988-29.41
		c-10.848-1.14-20.601-2.857-29.264-5.14c-8.658-2.286-17.605-5.996-26.835-11.14c-9.235-5.137-16.896-11.516-22.985-19.126
		c-6.09-7.614-11.088-17.61-14.987-29.979c-3.901-12.374-5.852-26.648-5.852-42.826c0-23.035,7.52-42.637,22.557-58.817
		c-7.044-17.318-6.379-36.732,1.997-58.24c5.52-1.715,13.706-0.428,24.554,3.853c10.85,4.283,18.794,7.952,23.84,10.994
		c5.046,3.041,9.089,5.618,12.135,7.708c17.705-4.947,35.976-7.421,54.818-7.421s37.117,2.474,54.823,7.421l10.849-6.849
		c7.419-4.57,16.18-8.758,26.262-12.565c10.088-3.805,17.802-4.853,23.134-3.138c8.562,21.509,9.325,40.922,2.279,58.24
		c15.036,16.18,22.559,35.787,22.559,58.817c0,16.178-1.958,30.497-5.853,42.966c-3.9,12.471-8.941,22.457-15.125,29.979
		c-6.191,7.521-13.901,13.85-23.131,18.986c-9.232,5.14-18.182,8.85-26.84,11.136c-8.662,2.286-18.415,4.004-29.263,5.146
		c9.894,8.562,14.842,22.077,14.842,40.539v60.237c0,3.422,1.19,6.279,3.572,8.562c2.379,2.279,6.136,2.95,11.276,1.995
		c44.163-14.653,80.185-41.062,108.068-79.226c27.88-38.161,41.825-81.126,41.825-128.906
		C438.536,184.851,428.728,148.168,409.132,114.573z"/>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#esp-idf的使用">ESP-IDF的使用</a></li>
    <li><a href="#c语言基础">C语言基础</a></li>
    <li><a href="#free-rtos">Free RTOS</a>
      <ol>
        <li><a href="#任务函数">任务函数</a></li>
        <li><a href="#队列函数">队列函数</a></li>
        <li><a href="#时钟函数">时钟函数</a></li>
        <li><a href="#互斥锁">互斥锁</a></li>
      </ol>
    </li>
    <li><a href="#具体实现">具体实现</a>
      <ol>
        <li><a href="#led任务">LED任务</a></li>
        <li><a href="#ttp229电容触摸板">TTP229电容触摸板</a></li>
        <li><a href="#蜂鸣器buzzer">蜂鸣器（buzzer）</a></li>
        <li><a href="#oledssd1306">OLED（SSD1306）</a>
          <ol>
            <li><a href="#esp自带spi硬件">ESP自带SPI硬件</a></li>
            <li><a href="#软件模拟">软件模拟</a></li>
            <li><a href="#u8g2">u8g2</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#music">music</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/">
                <img src="/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/cover_hu_c8e104243ce5cde6.jpg"
                        srcset="/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/cover_hu_c8e104243ce5cde6.jpg 800w, /p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/cover_hu_7a3699b36c82dde9.jpg 1600w"
                        width="800" 
                        height="291" 
                        loading="lazy"
                        alt="Featured image of post ~科中考核电子琴酱拯救计划~" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/~%E7%A7%91%E4%B8%AD%E8%80%83%E6%A0%B8%E7%94%B5%E5%AD%90%E7%90%B4%E9%85%B1%E6%8B%AF%E6%95%91%E8%AE%A1%E5%88%92~/">~科中考核电子琴酱拯救计划~</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-10-31</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>首先，我是新手！
首先，我是新手！！
首先，我是新手！！！
<em>（重要的事情说三遍！）</em>
作为嵌入式新手，我的代码一定存在缺陷和不完美，实现的功能也十分基础，所以别让新人太难办呜呜呜~</p>
<p>本文将重点介绍有关于本次电子琴酱拯救计划的主要实现思路，没错，和论文写的截然不同，论文主要还是按照模板写的，而且为了字数有些语言不通顺，而博客就很随意了，嗯就是主这样~</p>
<div style="text-align:center; color:rgb(255, 165, 0);"><strong>
首先，我需要简单介绍一下ELAB！ELAB是大连理工大学电气创新实践基地，原先为科技中心
</strong></div>
<div style="text-align:center; color:rgb(255, 165, 0);"><strong>
故也称为“科中”~
</strong></div>
<h2 style="text-align:center;">基本信息</h2>
<p><strong>关于本次考核电子琴酱，你最好知道：</strong></p>
<ul>
<li>我使用了以下原件：ESP32-WROOM-32E-N4
SS8550
TTP229-BSF-16
WS2812B
TYPE-C 16PIN 2MD(073)
SSD1306（7线）</li>
<li>使用官方在VScode上的插件ESP-IDF编程，配置为espidfv5.5</li>
<li>c语言</li>
<li>操作系统是Windows11 24H2</li>
<li>本文中的AI均指代谷歌gemini</li>
<li>我的全部文件在github上发布：<a class="link" href="https://github.com/sEvilDragon/ELABelectronic-organ.git"  target="_blank" rel="noopener"
    >https://github.com/sEvilDragon/ELABelectronic-organ.git</a></li>
<li>工程结构如下：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="err">├──</span> <span class="n">CMakeLists</span><span class="p">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl">	<span class="err">├──</span> <span class="n">components</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">└──</span> <span class="n">u8g2</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>       <span class="err">├──</span> <span class="n">inc</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>       <span class="err">├──</span> <span class="n">src</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>       <span class="err">├──</span> <span class="n">CMakeLists</span><span class="p">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>       <span class="err">└──</span> <span class="n">component</span><span class="p">.</span><span class="n">mk</span>
</span></span><span class="line"><span class="cl">	<span class="err">├──</span> <span class="n">main</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">CMakeLists</span><span class="p">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">electronic_organ_main</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">electronic_organ_main</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">led</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">music</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">TTP229</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">word</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">oled</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">buzzer</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">TASK_BUZZER</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">TASK_LED</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">├──</span> <span class="n">TASK_OLED</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="err">│</span>   <span class="err">└──</span> <span class="n">TASK_TTP</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="err">└──</span> <span class="n">README</span><span class="p">.</span><span class="n">md</span>        
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>考核原理图：![[图片1.png]]</li>
</ul>
<h2 id="esp-idf的使用">ESP-IDF的使用
</h2><p>简单介绍esp-idf插件的使用。</p>
<p>安装方面：我采取的方案是学长提供的先下载espidf对应文件（我下载的是espidfv5.5）然后再在插件的配置页面中进行配置的方案，似乎也可以直接在配置界面中安装。详细的配置过程网上有详细教程，不过多描述。配置过程中存在配置失败的问题，具体情况不一定，有可能是目录错误 <strong>（最好不要修改espidf的默认安装路径）</strong>，还有一种我遇到的很神秘的错误，需要删除两个神秘的文件就可以解决了，这个可以把报错扔给浏览器看看其他人是怎么解决的，AI在这方面似乎不靠谱，反正它没解决我的问题。</p>
<p>简单说一下操作，首先需要创建一个新的esp工程，在espidf的资源管理器（左侧工具栏）中有“新项目向导”点进去，配置一下项目名和项目位置（一般都不用改），使用esp32-custom board，然后choose template，使用template-app新建空项目（其实也就这一种能正常创建）。为了配合实际情况，还需要配置一下一些设置，点击下方状态栏中的SDK配置编辑器，搜索CPU，将160MHz改为240MHz，提高CPU运行频率，其实还有一个要改的，但我忘记是什么了，大概就是警告你4kb只使用2kb，使用的不充分，但我现在找不到了，这个是一条黄色的警告，也不影响使用，想改的话，扔给AI就好了。</p>
<p>下面最左边是git，主要就是几个键记一下，首先构建，烧录，监视，还有一个图标是小伙面的键可以一键执行三个。请注意，<strong>烧录之前一定要重新构建</strong>，有些问题可以通过esp-log在监视窗口查出（类似于正常c语言使用printf查看代码是否执行或打印对应变量看看值是什么），<strong>所以一般点小火苗一键执行就行</strong>。有些情况可能会提示需要修复，在VScode上方搜索栏中先输入“&gt;”找一下对应命令即可（一般要用一次esp.py.reconfigure命令）。</p>
<h2 id="c语言基础">C语言基础
</h2><p>其实没什么很重要的基础，基本上只要简单学过基本语法就行了。</p>
<p>循环，结构体，指针，函数，位运算这类能正常使用就可以。最好会跨文件，函数多的情况下还是分文件比较好，实际上不难，跟着AI都没问题。</p>
<h2 id="free-rtos">Free RTOS
</h2><p>就是个小型的操作系统。</p>
<p>我们主要用到它的任务函数，队列函数，时钟函数与互斥锁函数。接下来一一说明。</p>
<h3 id="任务函数">任务函数
</h3><p>任务函数是使用Free RTOS的主体函数，在app_main函数（其实就是esp特有的main函数）中使用，freertos可以使得一个核心同时进行多个任务（逻辑和正常操作系统是一样的，不详细介绍原理了），大概就是下面的形式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">led_animation_task</span><span class="p">,</span> <span class="s">&#34;ledanimation_task&#34;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>简单说明一下，第一个参数是对应的函数名，引号中的是系统中这个任务的名字（一般也就监视里能看见这东西），倒数第一个是核心（通常情况下，和通讯相关的任务会给至核0（PRO_CPU），和应用程序相关的任务分配到核1（APP_CPU），但你会发现我乱用的），倒数第二个是事件句柄传入（这个我没用到，有些任务可能用到，就是在某些情况才会执行任务的话就需要），那个5是事件优先级，大的先执行，所以重要的文件往大的写就好。</p>
<h3 id="队列函数">队列函数
</h3><p>这个还真不好介绍，可以简单的理解成freertos的一种处理吧，就是收到一个数据，让这个队列函数来处理一下，实现一些功能，比如我的工程中，读取到的按键信息发送给队列，队列对这个数据进行处理判断（其实就是if那种），在创建动画给LED处理。没错，实际上完全可以让这个处理在按键读取任务中完成，通过全局变量（或是互斥锁）的形式，传递给LED任务，只是freertos提供了另一种更稳定的方案吧算是。</p>
<h3 id="时钟函数">时钟函数
</h3><p>延时和读取时间任务，<strong>任务必须延时</strong>，因为多任务执行的核心是在一个任务延时时执行其他任务，所以任务一定要延时。至于读取时间，多数只是为了一些变化或者按键误触功能，比如我的项目中使用的三角函数的变量就是系统时间，按键误触就是读取系统时间保证在一定时间里连续点击算作一次点击，防止系统认为你点了一下判断为好多下。</p>
<p><strong>需要注意的是，esp中时钟相关的一些函数单位是不一样的。</strong>
<em>（单位好像可以自定义）</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span><span class="c1">//这个单位是1ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="c1">//这个单位是1微秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">xTaskGetTickCount</span><span class="p">()</span><span class="c1">//获取系统时间的函数，单位是10ms
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="互斥锁">互斥锁
</h3><p>互斥锁就是锁，防止一个变量同时被写入和读取的东西，其实也是无所谓的东西。毕竟一般也很难出现同时被写入和读取的情况发生。</p>
<p>下面简单展示一下我led中的互斥锁函数，大概都是一样的逻辑，但因为变量不同一些传入值和处理也不同，但框架一样。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 创建一个互斥锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">led_mutex_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">led_mutex</span> <span class="o">=</span> <span class="nf">xSemaphoreCreateMutex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">led_mutex</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ESP_LOGE</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;FATAL: Failed to create led_mutex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 创建一个函数用于写入互斥锁数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">led_mutex_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">xSemaphoreTake</span><span class="p">(</span><span class="n">led_mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">)</span> <span class="o">==</span> <span class="n">pdTRUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_shine</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">xSemaphoreGive</span><span class="p">(</span><span class="n">led_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 创建一个函数用于读取互斥锁数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">led_mutex_get</span><span class="p">(</span><span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">xSemaphoreTake</span><span class="p">(</span><span class="n">led_mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">)</span> <span class="o">==</span> <span class="n">pdTRUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">max_shine</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nf">xSemaphoreGive</span><span class="p">(</span><span class="n">led_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="具体实现">具体实现
</h2><h3 id="led任务">LED任务
</h3><p>我的WS2812使用官方的rmt驱动（也可以根据时序要求自己写，但我不会），这里需要引入新的官方头文件（<a class="link" href="https://components.espressif.com/components/espressif/led_strip/versions/3.0.1~1/readme"  target="_blank" rel="noopener"
    >espressif/led_strip • v3.0.1~1 • ESP Component Registry</a>），下载下来led_shrip文件后将文件放在“C:\Espressif\frameworks\esp-idf-v5.5\components”文件下（如果你安装时没改路径的话），然后重新构建工程即可（就是下面那个小扳手），官方提供的示例就是针对WS2812的，直接套用其初始化程序就好了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 灯rmt初始化（官方文档内容）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">led_strip_handle_t</span> <span class="nf">configure_led</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LED strip general initialization, according to your led board design
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">led_strip_config_t</span> <span class="n">strip_config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">strip_gpio_num</span> <span class="o">=</span> <span class="n">LED_STRIP_GPIO_PIN</span><span class="p">,</span>                        <span class="c1">// The GPIO that connected to the LED strip&#39;s data line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">max_leds</span> <span class="o">=</span> <span class="n">LED_STRIP_LED_COUNT</span><span class="p">,</span>                             <span class="c1">// The number of LEDs in the strip,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">led_model</span> <span class="o">=</span> <span class="n">LED_MODEL_WS2812</span><span class="p">,</span>                               <span class="c1">// LED strip model
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">color_component_format</span> <span class="o">=</span> <span class="n">LED_STRIP_COLOR_COMPONENT_FMT_GRB</span><span class="p">,</span> <span class="c1">// The color order of the strip: GRB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">invert_out</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="c1">// don&#39;t invert the output signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LED strip backend configuration: RMT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">led_strip_rmt_config_t</span> <span class="n">rmt_config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">clk_src</span> <span class="o">=</span> <span class="n">RMT_CLK_SRC_DEFAULT</span><span class="p">,</span>                    <span class="c1">// different clock source can lead to different power consumption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">resolution_hz</span> <span class="o">=</span> <span class="n">LED_STRIP_RMT_RES_HZ</span><span class="p">,</span>             <span class="c1">// RMT counter clock frequency
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">mem_block_symbols</span> <span class="o">=</span> <span class="n">LED_STRIP_MEMORY_BLOCK_WORDS</span><span class="p">,</span> <span class="c1">// the memory block size used by the RMT channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">with_dma</span> <span class="o">=</span> <span class="n">LED_STRIP_USE_DMA</span><span class="p">,</span> <span class="c1">// Using DMA can improve performance when driving more LEDs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LED Strip object handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">led_strip_handle_t</span> <span class="n">led_strip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ESP_ERROR_CHECK</span><span class="p">(</span><span class="nf">led_strip_new_rmt_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strip_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmt_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_strip</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;Created LED strip object with RMT backend&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">led_strip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我的LED动画实现了在按键按下时出现互动灯效（灯像波浪一样散开），这个是AI最初实现的，思路也很简单，大概是这样的：
创建一个结构体储存动画</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MAX_CONCURRENT_ANIMATIONS 6
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="n">struc</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">button_bit</span><span class="p">;</span>        <span class="c1">// 触发动画的按键位 (例如 2048, 1024, 16, 32 等)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TickType_t</span> <span class="n">start_time</span><span class="p">;</span> <span class="c1">// 动画开始的时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_active</span><span class="p">;</span>        <span class="c1">// 动画是否仍在进行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">center_led</span><span class="p">;</span>        <span class="c1">// 动画的中心 LED 序号 (0-11)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="kt">animation_instance_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">animation_instance_t</span> <span class="n">g_animations</span><span class="p">[</span><span class="n">MAX_CONCURRENT_ANIMATIONS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">//结构体数组，实现了多个任务可以同时进行
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>队列函数处理接收按键的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">vQueueProcessTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">received_bit</span><span class="p">;</span> <span class="c1">// 接收按键位掩码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 阻塞等待直到接收到新的按键事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">xQueueReceive</span><span class="p">(</span><span class="n">xQueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">received_bit</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">center_led</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">char</span> <span class="n">letter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">received_bit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">2048</span><span class="o">:</span><span class="c1">//这里的数字对应的是二进制，就是判断哪个键被按下了，1就是按下了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">center_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">letter</span> <span class="o">=</span> <span class="sc">&#39;7&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1024</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">center_led</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">letter</span> <span class="o">=</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">ESP_LOGW</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;Received bit %d does not map to a standard LED.&#34;</span><span class="p">,</span> <span class="n">received_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 2. 创建新的动画实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">animation_instance_t</span> <span class="n">new_animation</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">button_bit</span> <span class="o">=</span> <span class="n">received_bit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="nf">xTaskGetTickCount</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">center_led</span> <span class="o">=</span> <span class="n">center_led</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 3. 将新动画实例放入管理数组中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 找到第一个空闲的槽位（或允许替换最老的槽位）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CONCURRENT_ANIMATIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_animations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_active</span><span class="p">)</span> <span class="c1">// 原来是0会变为1就会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">g_animations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_animation</span><span class="p">;</span> <span class="c1">// 启动新动画
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="c1">//这个可有可无，因为前面有阻塞函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画处理上就是把每个动画数组通过计算得到值，由于我的动画函数还有其他功能，这里展示部分，全部代码在github上有。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 当前时间下的最大延伸距离 (范围从 0 到 MAX_REACH)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">float</span> <span class="n">current_max_reach</span> <span class="o">=</span> <span class="n">MAX_REACH</span> <span class="o">*</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">elapsed_ms</span> <span class="o">/</span> <span class="n">ANIMATION_DURATION_MS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 3. 实现延伸和渐淡逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">center_led</span> <span class="o">=</span> <span class="n">g_animations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">center_led</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">LED_STRIP_LED_COUNT</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 计算该像素点离中心的距离 (0, 1, 2, ...)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">int</span> <span class="n">distance</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">center_led</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 只有在当前最大延伸范围内才计算颜色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">current_max_reach</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 距离衰减率 (离中心越近越亮，从 1.0 递减到 0.0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">float</span> <span class="n">dist_falloff</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">distance</span> <span class="o">/</span> <span class="n">current_max_reach</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 最终强度 = (时间衰减) * (距离衰减)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">float</span> <span class="n">final_intensity</span> <span class="o">=</span> <span class="n">time_decay_factor</span> <span class="o">*</span> <span class="n">dist_falloff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 累加到最终颜色数组 (使用 uint16_t 防止溢出)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">final_r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">BASE_R</span> <span class="o">*</span> <span class="n">final_intensity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">final_g</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">BASE_G</span> <span class="o">*</span> <span class="n">final_intensity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">final_b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">BASE_B</span> <span class="o">*</span> <span class="n">final_intensity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用三角函数实现灯色随时间变化（也就是RGB灯效）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">final_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="mi">25</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">((</span><span class="nf">xTaskGetTickCount</span><span class="p">()</span> <span class="o">/</span> <span class="n">speed</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="mi">35</span><span class="p">)</span> <span class="o">*</span> <span class="n">set_led</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>speed是我的一个变量，这里是控制变化速度用的。
RGB实现上也可以用数组，那个似乎更稳定，但我选择了更简单的三角函数进行处理。实际上由于三角函数最后取整的问题，灯的变化很有限，效果不会那么好。</p>
<h3 id="ttp229电容触摸板">TTP229电容触摸板
</h3><p>提供参考连接<a class="link" href="https://zhuanlan.zhihu.com/p/502348392"  target="_blank" rel="noopener"
    >https://zhuanlan.zhihu.com/p/502348392</a></p>
<p>别忘了初始化：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ttp_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ESP_LOGE</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;开始初始化&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化GPIO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">gpio_config_t</span> <span class="n">io_conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 触摸芯片的SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">GPIO_INTR_DISABLE</span><span class="p">;</span>           <span class="c1">// 禁止中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">;</span>                 <span class="c1">// 输出模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">TTP229_PIN_SCL</span><span class="p">);</span> <span class="c1">// 选择引脚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_down_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                        <span class="c1">// 禁止下拉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_up_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                          <span class="c1">// 禁止上拉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_conf</span><span class="p">);</span>                           <span class="c1">// 应用配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 触摸芯片的SDO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">GPIO_INTR_DISABLE</span><span class="p">;</span>           <span class="c1">// 禁止中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_INPUT</span><span class="p">;</span>                  <span class="c1">// 输入模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">TTP229_PIN_SDO</span><span class="p">);</span> <span class="c1">// 选择引脚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* 防止 SDO 悬空导致默认高电平，启用下拉（若你的模块空闲为高，请改为 pull_up_en = 1） */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//实际情况是我把四种组合都试了一遍，该有的问题仍没有解决，下面详细说一下。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_down_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_up_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_conf</span><span class="p">);</span> <span class="c1">// 应用配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>相关的内容也可以参考官方文档，<strong>这个一定要对好接口</strong>，<strong>不同的接口状态其实际编写也不同</strong>。提供的文档使用的是stm32按照高电平有效进行的书写，但比如我的项目使用的就是低电平有效的情况，下面我提供一下我的模拟代码（低电平有效），实际上写反了也没啥事，因为电压转变和稳定是很快的，不延时一般也不会初始，更何况像我延时了100ms呢。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">vReadttp229Task</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">local_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 发起读序列：把 SDA 作为输出并产生启动脉冲，然后切回输入读取 */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDA_OUT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">TTP229_PIN_SDO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">TTP229_PIN_SDO</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SDA_IN</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TOUCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">TTP229_PIN_SCL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">TTP229_PIN_SCL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">gpio_get_level</span><span class="p">(</span><span class="n">TTP229_PIN_SDO</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_dat</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">local_dat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>TTP229是自己神秘的通讯协议，所以没用硬件支持，只能软件模拟通讯。然后就是说，TTP229这个我也不明白，反正有时候会串键，我是连电源时会串键，连充电宝就没事了。其他问题优先考虑硬件问题吧我不明白。而且我的ttp229高低有效会反转（有时高电平有效，有时低电平有效，我也不知道为啥），我简单加了一个判断，让它根据上电那一刻是高电平还是低电平来确定怎么读取。</p>
<h3 id="蜂鸣器buzzer">蜂鸣器（buzzer）
</h3><p>最简单的部分，我不懂DAC，所以用的PWM。
PWM频率对应发声的频率，PWM占空比对应声音大小（<strong>有些设备对占空比变化不明显，比如我的，调很小才能听出区别，同时注意，占空比为50%时最大</strong>）
PWM初始化和发声函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ledc_timer_config_t</span> <span class="n">pwm_timer</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">duty_resolution</span> <span class="o">=</span> <span class="n">LEDC_TIMER_12_BIT</span><span class="p">,</span> <span class="c1">// 占空比分辨率为12位二进制数，4095max
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="n">freq_hz</span> <span class="o">=</span> <span class="n">PWM_FREQ</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">speed_mode</span> <span class="o">=</span> <span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">timer_num</span> <span class="o">=</span> <span class="n">LEDC_TIMER</span><span class="p">};</span>  <span class="c1">// esp32有0~7高速通道，尽量选择0~7通道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ledc_timer_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwm_timer</span><span class="p">);</span> <span class="c1">// 调用配置函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ledc_channel_config_t</span> <span class="n">pwm_config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">LEDC_CHANNEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">duty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">gpio_num</span> <span class="o">=</span> <span class="n">BUZZER_GPIO</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">speed_mode</span> <span class="o">=</span> <span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">timer_sel</span> <span class="o">=</span> <span class="n">LEDC_TIMER</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ledc_channel_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwm_config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发声函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">buzzer_set_tone</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq_hz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">freq_hz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置新的频率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ledc_set_freq</span><span class="p">(</span><span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span> <span class="n">LEDC_TIMER</span><span class="p">,</span> <span class="n">freq_hz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ledc_set_duty</span><span class="p">(</span><span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span> <span class="n">LEDC_CHANNEL</span><span class="p">,</span> <span class="nf">buzzer_mutex_get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ledc_update_duty</span><span class="p">(</span><span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span> <span class="n">LEDC_CHANNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 停止声音：将占空比设置为 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ledc_set_duty</span><span class="p">(</span><span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span> <span class="n">LEDC_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ledc_update_duty</span><span class="p">(</span><span class="n">LEDC_HIGH_SPEED_MODE</span><span class="p">,</span> <span class="n">LEDC_CHANNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>后面根据按键发声就很简单了，我的实现是buzzertask每次循环检测按键读取值进行对应发声。也就是说，<strong>我的蜂鸣器和led函数是分开的</strong>，这很重要，为下面的音乐功能提供了方便。</p>
<h3 id="oledssd1306">OLED（SSD1306）
</h3><p>这个可有的说了，首先，虽然它是i2c和spi共用线的东西，但网上几乎都是i2c，就连它自己的手册都只是着重介绍了i2c，但我们要求用的spi。一些ssd1306的特性，可以参考官方文档和网上的各类介绍。</p>
<p>屏幕激活过程中，使用了3种SPI激活方式，接下来一一介绍</p>
<h4 id="esp自带spi硬件">ESP自带SPI硬件
</h4><p>使用esp32自身的spi硬件是最好的方式，因为硬件的延时很低，软件模拟的很难做到。
这个初始化跟着AI写一便就好了，不难，AI一遍过，只需要简单改一下参数
<em>（没有初始化函数，因为我找不到了，但跟AI说一下你要用spi初始化七线ssd1306就好了）</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">spi_transaction_t</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// 8位数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t</span><span class="p">.</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// DC 引脚拉低 (命令)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">spi_device_transmit</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">oled_send_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[],</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span> <span class="c1">// 这里的length是字节长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">spi_transaction_t</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spi_device_transmit</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 定位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">location</span><span class="p">(</span><span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">176</span> <span class="o">+</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">under</span> <span class="o">=</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b00001111</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="n">under</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">up</span> <span class="o">=</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b11110000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">up</span> <span class="o">=</span> <span class="n">up</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">up</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// OLED清屏（去除雪花）这里只写了清除一页的来做测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">OLED_clear</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">location</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_spi_pre_transfer_callback</span><span class="p">(</span><span class="kt">spi_transaction_t</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// t-&gt;user 存储了是命令还是数据的标识符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">dc_level</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_DC</span><span class="p">,</span> <span class="n">dc_level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xAE</span><span class="p">);</span> <span class="c1">// 说是一开始要关，为了安全
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 设置时针用的，这里套用建议的平均值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xD5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这个好像是用来确定多少行的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xA8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x3F</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 让屏幕像素点可以亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x8D</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 就是设置亮度的好像，也是套用常用值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x81</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xCF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这个好像就是预加载，提高显示效果的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xD9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xF1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置电压的，也是用了推荐的，说是防止鬼影
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xDB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启用页地址，我想实现的功能需要这个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这个就是调整用的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xA1</span><span class="p">);</span> <span class="c1">// (如果图像是镜像的，使用A0h)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// oled_send_cmd(0xC8); // (如果上下颠倒，使用C0h)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  显示自己想让他实现的功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xA4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="mh">0xAF</span><span class="p">);</span> <span class="c1">// 配置完了再打开屏幕
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_clear</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_word</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="软件模拟">软件模拟
</h4><p>这个最好能掌握，和上面TTP229的通讯一样，根据时序模拟SPI通讯，SSD1306的SPI是常规SPI</p>
<p>下面展示一下：
<em>（特别说明一下，其实不延时也没事，原因和上面一样，电压转换和稳定是一个瞬间的事情）</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">模拟实现</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_init</span><span class="p">();</span><span class="c1">//就是上面那个代码块的那个函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">OLED_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_direction</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_direction</span><span class="p">(</span><span class="n">OLED_SDA</span><span class="p">,</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_direction</span><span class="p">(</span><span class="n">OLED_CS</span><span class="p">,</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_direction</span><span class="p">(</span><span class="n">OLED_DC</span><span class="p">,</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_direction</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="c1">// 拉低 RES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>  <span class="c1">// 延迟一段时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>    <span class="c1">// 释放 RES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span> <span class="c1">// 再次等待设备启动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">oled_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_send_cmd</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_CS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_DC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SDA</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SDA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_CS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_send_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[],</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_CS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_DC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SDA</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">esp_rom_delay_us</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="u8g2">u8g2
</h4><p>不难，但这很重要，从上面就能看出，我在这个项目中引入了u8g2。</p>
<p>u8g2内置了软件激活ssd1306的方案，难的是怎么引入u8g2，这里我们使用的是对单个文件引入u8g2，这里提供教程来源&lt;<a class="link" href="https://zhuanlan.zhihu.com/p/587171646"  target="_blank" rel="noopener"
    >基于esp-idf移植使用u8g2 - 知乎</a>&gt;</p>
<p><strong>好好跟着教程写cmake文件，别问AI，AI提供的cmake有问题（可能是版本吧），一定是跑不起来的！</strong>
<strong>一定要禁用硬件SPI，硬件SPI会强制接管IO口，让软件SPI起不来作用！！</strong>
<strong>一定要注意命名和文件格式！！</strong></p>
<p>实际上我写的和教程有些许区别，可以参考一下（如果和我一样教程不行的话）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">idf_component_register</span><span class="p">(</span><span class="n">SRCS</span> <span class="s">&#34;src/mui.c&#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/mui_u8g2.c&#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_bitmap.c&#34;</span>    
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_box.c&#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_buffer.c&#34;</span>    
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_button.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_circle.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_cleardisplay.c&#34;</span>                  
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_d_memory.c&#34;</span>                  
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_d_setup.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_font.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_fonts.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_hvline.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_input_value.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_intersection.c&#34;</span>      
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_kerning.c&#34;</span>            
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_line.c&#34;</span>            
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_ll_hvline.c&#34;</span>  
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_message.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_polygon.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_selection_list.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8g2_setup.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8log.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8log_u8g2.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8log_u8x8.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_8x8.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_byte.c&#34;</span>      
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_cad.c&#34;</span>            
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_capture.c&#34;</span>    
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_debounce.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_display.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_d_ssd1306_128x64_noname.c&#34;</span>
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_fonts.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_gpio.c&#34;</span>            
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_input_value.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_message.c&#34;</span>          
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_selection_list.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_setup.c&#34;</span>              
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_string.c&#34;</span>        
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_u16toa.c&#34;</span>    
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;src/u8x8_u8toa.c&#34;</span>  
</span></span><span class="line"><span class="cl">                            <span class="n">INCLUDE_DIRS</span> <span class="s">&#34;inc&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">REQUIRES</span> <span class="s">&#34;driver&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>u8g2激活SPI很简单，是一套标准流程，这里还是展示一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="nf">u8g2_gpio_and_delay_cb</span><span class="p">(</span><span class="kt">u8x8_t</span> <span class="o">*</span><span class="n">u8x8</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">arg_int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_AND_DELAY_INIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_SPI_CLOCK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SCL</span><span class="p">,</span> <span class="n">arg_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_SPI_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_SDA</span><span class="p">,</span> <span class="n">arg_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_CS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_CS</span><span class="p">,</span> <span class="n">arg_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_DC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_DC</span><span class="p">,</span> <span class="n">arg_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_GPIO_RESET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="n">arg_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">U8X8_MSG_DELAY_MILLI</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="n">arg_int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">u8g2_app_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_Setup_ssd1306_128x64_noname_f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">U8G2_R0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">u8x8_byte_4wire_sw_spi</span><span class="p">,</span> <span class="c1">// &lt;-- 使用 U8G2 内置的软件 SPI 驱动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                       <span class="n">u8g2_gpio_and_delay_cb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_InitDisplay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetPowerSave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_ClearBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SendBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">oled_spi_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ESP_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;初始化 OLED GPIO 和复位&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化所有需要的 GPIO（包括 SCL, SDA, CS, DC, RES）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">gpio_config_t</span> <span class="n">io_conf</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">io_conf</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">GPIO_INTR_DISABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">io_conf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 确保这里包含了所有 SPI 信号线，因为它们现在是普通 GPIO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">io_conf</span><span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">OLED_SCL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">OLED_SDA</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">OLED_CS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">OLED_DC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">OLED_RES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_down_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">io_conf</span><span class="p">.</span><span class="n">pull_up_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行硬件复位操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gpio_set_level</span><span class="p">(</span><span class="n">OLED_RES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_app_init</span><span class="p">()</span><span class="err">；</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OLED_menu</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>展示屏幕的一个页码代码，其他基本是一样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">OLED_menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">display_buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span> <span class="c1">// 临时缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">array_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>     <span class="c1">// 想要打印的数组索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">u8g2_ClearBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetFont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">u8g2_font_helvR08_tf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#34;Ciallo~&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetFont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">u8g2_font_helvR14_tf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="n">array_index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">display_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="n">array_index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">display_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetFont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">u8g2_font_helvR24_tf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">display_buffer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;%c&#34;</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="n">array_index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">display_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetFont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">u8g2_font_unifont_t_chinese3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="s">&#34;设定B&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="s">&#34;菜单L&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SendBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>展示这个代码主要是因为这里面刚刚好展示了一个重要的点，<strong>首先，写入中文一定要用DrawUTF8，其次，想输出变量，一定要建立缓冲区</strong>。</p>
<p><strong>如果不使用u8g2的话要注意ssd1306是页地址寻址！</strong> 详见官方文档</p>
<p>u8g2支持你定位在屏幕外面（虽然写不上去），利用这个特性，可以实现屏幕文字滚动效果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">OLED_scroll_music</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SetFont</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">u8g2_font_unifont_t_chinese3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text_to_scroll</span> <span class="o">=</span> <span class="s">&#34;  正在播放&lt;春日影&gt; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">u8g2_uint_t</span> <span class="n">text_width</span> <span class="o">=</span> <span class="nf">u8g2_GetUTF8Width</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">text_to_scroll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_DrawUTF8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">text_to_scroll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">u8g2_SendBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u8g2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">text_width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>u8g2支持丰富的第三方库，只是我没用~
比如说u8g2自带中文库真的很菜，有第三方中文库，甚至字体都不止一种，也有ui，动画库甚至是游戏库，不再过多论述。</p>
<h2 id="music">music
</h2><p>展示音乐函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">musictask</span><span class="p">(</span><span class="kt">int</span> <span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">continue_time</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stop_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">check_oled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ttp_mutex_write</span><span class="p">(</span><span class="o">~</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="n">message</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">b1111111100001111</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">xQueueSend</span><span class="p">(</span><span class="n">xQueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="o">!=</span> <span class="n">pdPASS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ESP_LOGW</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&#34;Queue full, message not sent&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">mew_dat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">datt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">continue_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">check_oled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">panduan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">mew_dat</span> <span class="o">=</span> <span class="nf">vReadttp229Task</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">datt</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="nf">vReadttp229Task</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">mew_dat</span> <span class="o">=</span> <span class="p">(</span><span class="n">datt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">65503</span><span class="p">)</span> <span class="o">==</span> <span class="mi">65503</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">mew_dat</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">check_oled</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="p">((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">check_oled</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">panduan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mew_dat</span> <span class="o">=</span> <span class="nf">vReadttp229Task</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">datt</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="nf">vReadttp229Task</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mew_dat</span> <span class="o">=</span> <span class="p">(</span><span class="n">datt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">check_led</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">check_led</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">check_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="mi">64</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">speedm</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">speedm</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        <span class="n">speedm</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">150</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">check_oled</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(((</span><span class="o">~</span><span class="n">mew_dat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">150</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">ttp_mutex_write</span><span class="p">(</span><span class="mi">65535</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">check_oled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">check_oled</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">continue_time</span> <span class="o">-=</span> <span class="n">speedm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">continue_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ttp_mutex_write</span><span class="p">(</span><span class="mi">65535</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">vTaskDelay</span><span class="p">(</span><span class="nf">pdMS_TO_TICKS</span><span class="p">(</span><span class="n">stop_time</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>简单来说，我的音乐函数是通过模拟传入按键实现的，然后将按键传给队列实现led对应发光，修改互斥锁的按键值，实现蜂鸣器对应发声。所以需要注意，<strong>上面的两点决定了music函数不能放在led和蜂鸣器任务中</strong>，不然对应函数的功能是不会执行的，因为music函数还没走完。</p>
<p>由于传入的是音符，有多少个音就有多少个上述的函数执行，所以快进只要return函数就好了，开头检测是否结束了音乐实现关闭功能，也就是说，虽然看起来音乐函数结束了，实际上并没有，只是接下来的函数刚开始就return了看起来像没有执行一样，暂停就是进入死循环而已。</p>
<p>由于蜂鸣器和led是分开激活的特性，可以将该音乐函数改写成一个简单的音游，只需要让蜂鸣器发声只发生在对应按键被按下时就行了，不多描述。</p>
<h2 style="text-align:center;color:rgb(255, 0, 0);"><strong>感谢</strong></h2>
<div style="text-align:center;"><strong> 以上就是电子琴的全部，这是我第一次接触嵌入式，肯定有些地方做的不够到位，希望我能在后续的学习过程中不断专精。感谢你能观看这篇博客！ </strong></div>
<center><strong>感谢所有学长提供的帮助！</strong></center>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/elab/">ELAB</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 小恐龙大魔王!sEvil_Dragon
    </section>
    
    <section class="powerby">
        
            Just Believe！！！ <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
